<!DOCTYPE html>
<html lang="en">

<head>
    <title>Unity ECS 框架摸索第五章：利用 Prefab 实例化 Entity 及其销毁 | Celestial</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://paakmau.github.io/style.css">
    <link rel="stylesheet" href="https://paakmau.github.io/color/orange-auto.css">

        <link rel="stylesheet" href="https://paakmau.github.io/color/background_auto.css">
    
    <link rel="stylesheet" href="https://paakmau.github.io/font-hack-subset.css">

    <meta name="description" content="">

    <meta property="og:description" content="">
    <meta property="og:title" content="Unity ECS 框架摸索第五章：利用 Prefab 实例化 Entity 及其销毁 | Celestial">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://paakmau.github.io/202002031405/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="Unity ECS 框架摸索第五章：利用 Prefab 实例化 Entity 及其销毁 | Celestial">
    <meta property="twitter:domain" content="paakmau.github.io">
    <meta property="twitter:url" content="https://paakmau.github.io/202002031405/">

                <link rel="alternate" type="application/rss+xml" title="Celestial RSS Feed" href="https://paakmau.github.io/rss.xml" />
                <link rel="alternate" type="application/atom+xml" title="Celestial Atom Feed" href="https://paakmau.github.io/atom.xml" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral'
        });
    </script>
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://paakmau.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Celestial
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://paakmau.github.io">home</a></li>
            
                <li><a href="https://paakmau.github.io/tags">tags</a></li>
            
                <li><a href="https://github.com/paakmau" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://paakmau.github.io/202002031405/">Unity ECS 框架摸索第五章：利用 Prefab 实例化 Entity 及其销毁</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2020-02-03
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/unity-ecs/">#Unity ECS</a></span>
    

        <div class="post-content">
            <p>一般游戏中都避不开实体的动态生成与动态销毁。</p>
<p>本文演示使用 Prefab 创建旋转的立方体方阵并定时销毁。</p>
<span id="continue-reading"></span><h2 id="zong-ti-si-lu">总体思路</h2>
<p>放置一个生成器实体在场景中，让一个 <code>SpawnerSystem</code> 根据它创建立方体方阵。<br>
旋转与销毁的思路都与前文相同，让旋转系统筛选旋转速度组件并控制旋转，让销毁系统筛选销毁时间组件并控制销毁即可。</p>
<h2 id="zhi-zuo-xuan-zhuan-li-fang-ti-de-prefab">制作旋转立方体的 Prefab</h2>
<p>其实跟 Hello World 中基本一致，但是为了表述清晰这里还是写一下。</p>
<p>首先编写用于控制旋转速度的组件<br>
<code>RotationSpeed.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>System;
</span><span>
</span><span>[</span><span style="color:#ffb964;">Serializable</span><span>]
</span><span style="color:#8fbfdc;">public struct </span><span style="color:#ffb964;">RotationSpeed </span><span>: </span><span style="color:#ffb964;">IComponentData
</span><span>{
</span><span>    </span><span style="color:#8fbfdc;">public float </span><span style="color:#ffb964;">RadiansPerSecond</span><span>;
</span><span>}
</span></code></pre>
<p>然后还有控制自动销毁的组件<br>
<code>DestroyTime.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>System;
</span><span>
</span><span>[</span><span style="color:#ffb964;">Serializable</span><span>]
</span><span style="color:#8fbfdc;">public struct </span><span style="color:#ffb964;">DestroyTime </span><span>: </span><span style="color:#ffb964;">IComponentData
</span><span>{
</span><span>    </span><span style="color:#8fbfdc;">public float </span><span style="color:#ffb964;">TimeBeforeDestroy</span><span>;
</span><span>}
</span></code></pre>
<p>接下来则是用于添加上面两个组件的 Authoring<br>
<code>RotatingCubeAuthoring.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Mathematics;
</span><span style="color:#8fbfdc;">using </span><span>UnityEngine;
</span><span>
</span><span>[</span><span style="color:#ffb964;">RequiresEntityConversion</span><span>]
</span><span style="color:#8fbfdc;">public class </span><span style="color:#ffb964;">RotatingCubeAuthoring </span><span>: </span><span style="color:#ffb964;">MonoBehaviour</span><span>, </span><span style="color:#ffb964;">IConvertGameObjectToEntity </span><span>{
</span><span>    </span><span style="color:#8fbfdc;">public float </span><span style="color:#ffb964;">DegreePerSecond </span><span>= </span><span style="color:#cf6a4c;">180</span><span>;
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">Convert </span><span>(Entity </span><span style="color:#ffb964;">entity</span><span>, EntityManager </span><span style="color:#ffb964;">dstManager</span><span>, GameObjectConversionSystem </span><span style="color:#ffb964;">conversionSystem</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">rotationSpeedCmpt </span><span>= new RotationSpeed { </span><span style="color:#ffb964;">RadiansPerSecond </span><span>= </span><span style="color:#ffb964;">math</span><span>.</span><span style="color:#ffb964;">radians </span><span>(</span><span style="color:#ffb964;">DegreePerSecond</span><span>) };
</span><span>        </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">destroyTimeCmpt </span><span>= new DestroyTime { </span><span style="color:#ffb964;">TimeBeforeDestroy </span><span>= </span><span style="color:#cf6a4c;">5 </span><span>};
</span><span>        </span><span style="color:#ffb964;">dstManager</span><span>.</span><span style="color:#ffb964;">AddComponentData </span><span>(</span><span style="color:#ffb964;">entity</span><span>, </span><span style="color:#ffb964;">rotationSpeedCmpt</span><span>);
</span><span>        </span><span style="color:#ffb964;">dstManager</span><span>.</span><span style="color:#ffb964;">AddComponentData </span><span>(</span><span style="color:#ffb964;">entity</span><span>, </span><span style="color:#ffb964;">destroyTimeCmpt</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<p>最后创建一个基于 Cube 的 Prefab，移除 <code>Collider</code>，挂载 <code>ConvertToEntity</code> 与 <code>RotatingCubeAuthoring</code> 脚本。</p>
<p>至此，就能使用该 Prefab 批量生成旋转立方体的 Entity 实例。</p>
<h2 id="bian-xie-xuan-zhuan-xi-tong">编写旋转系统</h2>
<p>与 Hello World 完全一致</p>
<p>控制方块旋转的 System<br>
<code>RotateSpeedSystem.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Burst;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Collections;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Jobs;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Mathematics;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Transforms;
</span><span>
</span><span style="color:#8fbfdc;">public class </span><span style="color:#ffb964;">RotateSpeedSystem </span><span>: </span><span style="color:#ffb964;">JobComponentSystem </span><span>{
</span><span>
</span><span>    [</span><span style="color:#ffb964;">BurstCompile</span><span>]
</span><span>    </span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">RotationJob </span><span>: </span><span style="color:#ffb964;">IJobForEach</span><span>&lt;Rotation, RotationSpeed&gt; {
</span><span>        </span><span style="color:#8fbfdc;">public float </span><span style="color:#ffb964;">DeltaTime</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">Execute </span><span>(</span><span style="color:#8fbfdc;">ref </span><span>Rotation </span><span style="color:#ffb964;">rotation</span><span>, [</span><span style="color:#ffb964;">ReadOnly</span><span>] </span><span style="color:#8fbfdc;">ref </span><span>RotationSpeed </span><span style="color:#ffb964;">rotationSpeed</span><span>) {
</span><span>            </span><span style="color:#ffb964;">rotation </span><span>= new Rotation {
</span><span>                </span><span style="color:#ffb964;">Value </span><span>= </span><span style="color:#ffb964;">math</span><span>.</span><span style="color:#ffb964;">mul </span><span>(</span><span style="color:#ffb964;">math</span><span>.</span><span style="color:#ffb964;">normalize </span><span>(</span><span style="color:#ffb964;">rotation</span><span>.</span><span style="color:#ffb964;">Value</span><span>), </span><span style="color:#ffb964;">quaternion</span><span>.</span><span style="color:#ffb964;">AxisAngle </span><span>(</span><span style="color:#ffb964;">math</span><span>.</span><span style="color:#ffb964;">up </span><span>(), </span><span style="color:#ffb964;">rotationSpeed</span><span>.</span><span style="color:#ffb964;">RadiansPerSecond </span><span>* </span><span style="color:#ffb964;">DeltaTime</span><span>))
</span><span>            };
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">protected override </span><span>JobHandle </span><span style="color:#fad07a;">OnUpdate </span><span>(JobHandle </span><span style="color:#ffb964;">inputDeps</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">return </span><span>new RotationJob { </span><span style="color:#ffb964;">DeltaTime </span><span>= </span><span style="color:#ffb964;">Time</span><span>.</span><span style="color:#ffb964;">DeltaTime </span><span>}.</span><span style="color:#ffb964;">Schedule </span><span>(</span><span style="color:#ffb964;">this</span><span>, </span><span style="color:#ffb964;">inputDeps</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<h2 id="bian-xie-xiao-hui-entity-de-xi-tong">编写销毁 Entity 的系统</h2>
<p>筛选 <code>DestroyTime</code> 组件，让 <code>TimeBeforeDestroy</code> 不断随时间减少，在它归零的时候销毁它所属的 Entity。</p>
<p>下面是销毁系统的具体代码<br>
<code>DestroySystem.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Burst;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Collections;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Jobs;
</span><span>
</span><span style="color:#8fbfdc;">public class </span><span style="color:#ffb964;">DestroySystem </span><span>: </span><span style="color:#ffb964;">JobComponentSystem </span><span>{
</span><span>    BeginInitializationEntityCommandBufferSystem </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">protected override void </span><span style="color:#fad07a;">OnCreate </span><span>() {
</span><span>        </span><span style="color:#ffb964;">m_EntityCommandBufferSystem </span><span>= </span><span style="color:#ffb964;">World</span><span>.</span><span style="color:#ffb964;">GetOrCreateSystem</span><span>&lt;BeginInitializationEntityCommandBufferSystem&gt; ();
</span><span>    }
</span><span>
</span><span>    [</span><span style="color:#ffb964;">BurstCompile</span><span>]
</span><span>    </span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">DestroyJob </span><span>: </span><span style="color:#ffb964;">IJobForEachWithEntity</span><span>&lt;DestroyTime&gt; {
</span><span>        </span><span style="color:#8fbfdc;">public float </span><span style="color:#ffb964;">DeltaTime</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">public </span><span style="color:#ffb964;">EntityCommandBuffer</span><span>.Concurrent </span><span style="color:#ffb964;">CmdBuffer</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">Execute </span><span>(Entity </span><span style="color:#ffb964;">entity</span><span>, </span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#8fbfdc;">ref </span><span>DestroyTime </span><span style="color:#ffb964;">destroyTime</span><span>) {
</span><span>            </span><span style="color:#ffb964;">destroyTime</span><span>.</span><span style="color:#ffb964;">TimeBeforeDestroy </span><span>-= </span><span style="color:#ffb964;">DeltaTime</span><span>;
</span><span>            </span><span style="color:#8fbfdc;">if </span><span>(</span><span style="color:#ffb964;">destroyTime</span><span>.</span><span style="color:#ffb964;">TimeBeforeDestroy </span><span>&lt;= </span><span style="color:#cf6a4c;">0</span><span>)
</span><span>                </span><span style="color:#ffb964;">CmdBuffer</span><span>.</span><span style="color:#ffb964;">DestroyEntity </span><span>(</span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#ffb964;">entity</span><span>);
</span><span>        }
</span><span>    }
</span><span>    </span><span style="color:#8fbfdc;">protected override </span><span>JobHandle </span><span style="color:#fad07a;">OnUpdate </span><span>(JobHandle </span><span style="color:#ffb964;">inputDeps</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">jobHandle </span><span>= new DestroyJob { </span><span style="color:#ffb964;">DeltaTime </span><span>= </span><span style="color:#ffb964;">Time</span><span>.</span><span style="color:#ffb964;">DeltaTime</span><span>, </span><span style="color:#ffb964;">CmdBuffer </span><span>= </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>.</span><span style="color:#ffb964;">CreateCommandBuffer </span><span>().</span><span style="color:#ffb964;">ToConcurrent </span><span>() }.</span><span style="color:#ffb964;">Schedule </span><span>(</span><span style="color:#ffb964;">this</span><span>, </span><span style="color:#ffb964;">inputDeps</span><span>);
</span><span>        </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>.</span><span style="color:#ffb964;">AddJobHandleForProducer </span><span>(</span><span style="color:#ffb964;">jobHandle</span><span>);
</span><span>        </span><span style="color:#8fbfdc;">return </span><span style="color:#ffb964;">jobHandle</span><span>;
</span><span>    }
</span><span>}
</span></code></pre>
<p>解释：<br>
在一个 System 遍历 Entity 的时候，如果直接将某个 Entity 销毁，会导致遍历出现错乱。
因此需要将销毁操作放入一个命令缓冲区，只要在下次 Tick 该系统运行之前执行这个命令缓冲区中的所有操作，就能安全地销毁 Entity。<br>
然后每一个 Tick 里系统是有执行顺序的，我们找到所有系统中第一个执行的系统 <code>BeginInitializationEntityCommandBufferSystem</code>。
于是调用它的接口创建命令缓冲区，写入销毁命令，在下次 Tick 的时候这个系统就会执行我们写入的销毁命令。<br>
另外，<code>IJobForEachWithEntity</code> 跟前文的 <code>IJobForEach</code> 基本一致，但是使用它遍历可以拿到 Entity。
这里我们需要拿到 Entity 以便销毁它。</p>
<h2 id="bian-xie-bing-fang-zhi-spawner">编写并放置 Spawner</h2>
<p>首先是 <code>Spawner</code> 组件用于记录 Prefab 与生成数量信息<br>
生成的实体会形成一个方阵，<code>CountX</code>、<code>CountY</code> 分别表示方阵横纵方向上实体的数量<br>
<code>Spawner.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>System;
</span><span>
</span><span>[</span><span style="color:#ffb964;">Serializable</span><span>]
</span><span style="color:#8fbfdc;">public struct </span><span style="color:#ffb964;">Spawner </span><span>: </span><span style="color:#ffb964;">IComponentData </span><span>{
</span><span>    </span><span style="color:#8fbfdc;">public </span><span>Entity </span><span style="color:#ffb964;">Prefab</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">public int </span><span style="color:#ffb964;">CountX</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">public int </span><span style="color:#ffb964;">CountY</span><span>;
</span><span>}
</span></code></pre>
<p>然后编写 Authoring 脚本<br>
<code>SpawnerAuthoring.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>System.Collections.Generic;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>UnityEngine;
</span><span>
</span><span>[</span><span style="color:#ffb964;">RequiresEntityConversion</span><span>]
</span><span style="color:#8fbfdc;">public class </span><span style="color:#ffb964;">SpawnerAuthoring </span><span>: </span><span style="color:#ffb964;">MonoBehaviour</span><span>, </span><span style="color:#ffb964;">IConvertGameObjectToEntity</span><span>, </span><span style="color:#ffb964;">IDeclareReferencedPrefabs </span><span>{
</span><span>    </span><span style="color:#8fbfdc;">public </span><span>GameObject </span><span style="color:#ffb964;">Prefab</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">public int </span><span style="color:#ffb964;">CountX</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">public int </span><span style="color:#ffb964;">CountY</span><span>;
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">DeclareReferencedPrefabs </span><span>(List&lt;GameObject&gt; </span><span style="color:#ffb964;">referencedPrefabs</span><span>) {
</span><span>        </span><span style="color:#ffb964;">referencedPrefabs</span><span>.</span><span style="color:#ffb964;">Add </span><span>(</span><span style="color:#ffb964;">Prefab</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">Convert </span><span>(Entity </span><span style="color:#ffb964;">entity</span><span>, EntityManager </span><span style="color:#ffb964;">dstManager</span><span>, GameObjectConversionSystem </span><span style="color:#ffb964;">conversionSystem</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">spawner </span><span>= new Spawner {
</span><span>            </span><span style="color:#ffb964;">Prefab </span><span>= </span><span style="color:#ffb964;">conversionSystem</span><span>.</span><span style="color:#ffb964;">GetPrimaryEntity </span><span>(</span><span style="color:#ffb964;">Prefab</span><span>),
</span><span>            </span><span style="color:#ffb964;">CountX </span><span>= </span><span style="color:#ffb964;">CountX</span><span>,
</span><span>            </span><span style="color:#ffb964;">CountY </span><span>= </span><span style="color:#ffb964;">CountY
</span><span>        };
</span><span>        </span><span style="color:#ffb964;">dstManager</span><span>.</span><span style="color:#ffb964;">AddComponentData </span><span>(</span><span style="color:#ffb964;">entity</span><span>, </span><span style="color:#ffb964;">spawner</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<p>解释：<br>
它不仅把 <code>CountX</code>、<code>CountY</code> 传入组件，还使用 <code>GameObjectConversionSystem</code> 把 GameObject 类型的 Prefab 转化为 Entity。<br>
具体为什么这样写不用管，当作咒语记下来就好。（反正 api 还会改不少）</p>
<p>然后在 Scene 中新建一个空的 GameObject 命名为 <code>Spawner</code>，挂载 <code>ConvertToEntity</code> 与 <code>SpawnerAuthoring</code> 脚本</p>
<h2 id="bian-xie-spawnersystem">编写 SpawnerSystem</h2>
<p>现在场景中已经存在一个生成器实体了，我们只需要写一个系统读取该实体储存的 Prefab 信息，就能实例化任意多个 Prefab 了。</p>
<p>当然，为了防止反复访问这个生成器实体而重复实例化 Prefab，需要在实例化 Prefab 之后就立刻销毁该实体</p>
<p>代码如下<br>
<code>SpawnerSystem.cs</code></p>
<pre data-lang="cs" style="background-color:#151515;color:#e8e8d3;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#8fbfdc;">using </span><span>Unity.Burst;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Collections;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Entities;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Jobs;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Mathematics;
</span><span style="color:#8fbfdc;">using </span><span>Unity.Transforms;
</span><span>
</span><span style="color:#8fbfdc;">public class </span><span style="color:#ffb964;">SpawnerSystem </span><span>: </span><span style="color:#ffb964;">JobComponentSystem </span><span>{
</span><span>    BeginInitializationEntityCommandBufferSystem </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">protected override void </span><span style="color:#fad07a;">OnCreate </span><span>() {
</span><span>        </span><span style="color:#ffb964;">m_EntityCommandBufferSystem </span><span>= </span><span style="color:#ffb964;">World</span><span>.</span><span style="color:#ffb964;">GetOrCreateSystem</span><span>&lt;BeginInitializationEntityCommandBufferSystem&gt; ();
</span><span>    }
</span><span>
</span><span>    [</span><span style="color:#ffb964;">BurstCompile</span><span>]
</span><span>    </span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">SpawnerJob </span><span>: </span><span style="color:#ffb964;">IJobForEachWithEntity</span><span>&lt;Spawner, LocalToWorld&gt; {
</span><span>        </span><span style="color:#8fbfdc;">public </span><span style="color:#ffb964;">EntityCommandBuffer</span><span>.Concurrent </span><span style="color:#ffb964;">CmdBuffer</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">public void </span><span style="color:#fad07a;">Execute </span><span>(Entity </span><span style="color:#ffb964;">entity</span><span>, </span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">entityInQueryIndex</span><span>, [</span><span style="color:#ffb964;">ReadOnly</span><span>] </span><span style="color:#8fbfdc;">ref </span><span>Spawner </span><span style="color:#ffb964;">spawner</span><span>, [</span><span style="color:#ffb964;">ReadOnly</span><span>] </span><span style="color:#8fbfdc;">ref </span><span>LocalToWorld </span><span style="color:#ffb964;">local</span><span>) {
</span><span>            </span><span style="color:#8fbfdc;">for </span><span>(</span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">i </span><span>= </span><span style="color:#cf6a4c;">0</span><span>; </span><span style="color:#ffb964;">i </span><span>&lt; </span><span style="color:#ffb964;">spawner</span><span>.</span><span style="color:#ffb964;">CountY</span><span>; </span><span style="color:#ffb964;">i</span><span>++)
</span><span>                </span><span style="color:#8fbfdc;">for </span><span>(</span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">j </span><span>= </span><span style="color:#cf6a4c;">0</span><span>; </span><span style="color:#ffb964;">j </span><span>&lt; </span><span style="color:#ffb964;">spawner</span><span>.</span><span style="color:#ffb964;">CountX</span><span>; </span><span style="color:#ffb964;">j</span><span>++) {
</span><span>                    </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">instance </span><span>= </span><span style="color:#ffb964;">CmdBuffer</span><span>.</span><span style="color:#ffb964;">Instantiate </span><span>(</span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#ffb964;">spawner</span><span>.</span><span style="color:#ffb964;">Prefab</span><span>);
</span><span>                    </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">position </span><span>= </span><span style="color:#ffb964;">math</span><span>.</span><span style="color:#ffb964;">transform </span><span>(</span><span style="color:#ffb964;">local</span><span>.</span><span style="color:#ffb964;">Value</span><span>,
</span><span>                        new float3 (</span><span style="color:#ffb964;">j </span><span>* </span><span style="color:#cf6a4c;">1.3</span><span style="color:#8fbfdc;">F</span><span>, </span><span style="color:#ffb964;">noise</span><span>.</span><span style="color:#ffb964;">cnoise </span><span>(new float2 (</span><span style="color:#ffb964;">j</span><span>, </span><span style="color:#ffb964;">i</span><span>) * </span><span style="color:#cf6a4c;">0.21</span><span style="color:#8fbfdc;">F</span><span>) * </span><span style="color:#cf6a4c;">2</span><span>, </span><span style="color:#ffb964;">i </span><span>* </span><span style="color:#cf6a4c;">1.3</span><span style="color:#8fbfdc;">F</span><span>));
</span><span>                    </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">destroyTime </span><span>= </span><span style="color:#cf6a4c;">5 </span><span>+ </span><span style="color:#ffb964;">noise</span><span>.</span><span style="color:#ffb964;">cnoise </span><span>(new float2 (</span><span style="color:#ffb964;">j</span><span>, </span><span style="color:#ffb964;">i</span><span>) * </span><span style="color:#cf6a4c;">5.3</span><span style="color:#8fbfdc;">F</span><span>);
</span><span>                    </span><span style="color:#ffb964;">CmdBuffer</span><span>.</span><span style="color:#ffb964;">SetComponent </span><span>(</span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#ffb964;">instance</span><span>, new Translation { </span><span style="color:#ffb964;">Value </span><span>= </span><span style="color:#ffb964;">position </span><span>});
</span><span>                    </span><span style="color:#ffb964;">CmdBuffer</span><span>.</span><span style="color:#ffb964;">SetComponent </span><span>(</span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#ffb964;">instance</span><span>, new DestroyTime { </span><span style="color:#ffb964;">TimeBeforeDestroy </span><span>= </span><span style="color:#ffb964;">destroyTime </span><span>});
</span><span>                }
</span><span>            </span><span style="color:#ffb964;">CmdBuffer</span><span>.</span><span style="color:#ffb964;">DestroyEntity </span><span>(</span><span style="color:#ffb964;">entityInQueryIndex</span><span>, </span><span style="color:#ffb964;">entity</span><span>);
</span><span>        }
</span><span>    }
</span><span>    </span><span style="color:#8fbfdc;">protected override </span><span>JobHandle </span><span style="color:#fad07a;">OnUpdate </span><span>(JobHandle </span><span style="color:#ffb964;">inputDeps</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">var </span><span style="color:#ffb964;">jobHandle </span><span>= new SpawnerJob { </span><span style="color:#ffb964;">CmdBuffer </span><span>= </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>.</span><span style="color:#ffb964;">CreateCommandBuffer </span><span>().</span><span style="color:#ffb964;">ToConcurrent </span><span>() }.</span><span style="color:#ffb964;">Schedule </span><span>(</span><span style="color:#ffb964;">this</span><span>, </span><span style="color:#ffb964;">inputDeps</span><span>);
</span><span>        </span><span style="color:#ffb964;">m_EntityCommandBufferSystem</span><span>.</span><span style="color:#ffb964;">AddJobHandleForProducer </span><span>(</span><span style="color:#ffb964;">jobHandle</span><span>);
</span><span>        </span><span style="color:#8fbfdc;">return </span><span style="color:#ffb964;">jobHandle</span><span>;
</span><span>    }
</span><span>}
</span></code></pre>
<p>解释：<br>
同样的，在遍历实体过程中创建新的实体会导致遍历混乱，所以它也跟 <code>DestroySystem</code> 一样使用了命令缓冲区来创建新的实体。</p>
<h2 id="yun-xing-liu-cheng">运行流程</h2>
<p>首先 <code>SpawnerSystem</code> 筛选出了一个拥有 <code>Spawner</code> 组件的实体，根据该组件中的 Prefab 与方阵信息创建了整个方阵的旋转方块实体，最后销毁这个拥有 <code>Spawner</code> 组件的实体防止重复实例化 Prefab。</p>
<p>然后 <code>RotateSpeedSystem</code> 控制拥有 <code>RotationSpeed</code> 组件的方块旋转</p>
<p>还有 <code>DestroySystem</code> 筛选出拥有 <code>DestroyTime</code> 组件的实体，每个 Tick 都让 <code>TimeBeforeDestroy</code> 这个计时器减去 <code>DeltaTime</code>，并把计时器已经归零的 Entity 销毁。</p>

        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                    <hr />
                </div>
                <div class="pagination__buttons">
                        <span class="button previous">
                            <a href="https://paakmau.github.io/202002030137/">
                                <span class="button__icon">←</span>&nbsp;
                                <span class="button__text">Unity ECS 框架摸索第四章：Chunk</span>
                            </a>
                        </span>
                    
                    
                        <span class="button next">
                            <a href="https://paakmau.github.io/202002040123/">
                                <span class="button__text">Unity ECS 框架摸索第六章：更灵活的筛选与遍历</span>&nbsp;
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    </div>
            </div>
        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
