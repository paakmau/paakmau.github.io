<!DOCTYPE html>
<html lang="en">

<head>
    <title>快排的多线程优化 | Celestial</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://paakmau.github.io/style.css">
    <link rel="stylesheet" href="https://paakmau.github.io/color/orange-auto.css">

        <link rel="stylesheet" href="https://paakmau.github.io/color/background_auto.css">
    
    <link rel="stylesheet" href="https://paakmau.github.io/font-hack-subset.css">

    <meta name="description" content="">

    <meta property="og:description" content="">
    <meta property="og:title" content="快排的多线程优化 | Celestial">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://paakmau.github.io/202004212139/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="快排的多线程优化 | Celestial">
    <meta property="twitter:domain" content="paakmau.github.io">
    <meta property="twitter:url" content="https://paakmau.github.io/202004212139/">

                <link rel="alternate" type="application/rss+xml" title="Celestial RSS Feed" href="https://paakmau.github.io/rss.xml" />
                <link rel="alternate" type="application/atom+xml" title="Celestial Atom Feed" href="https://paakmau.github.io/atom.xml" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral'
        });
    </script>
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://paakmau.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Celestial
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://paakmau.github.io">home</a></li>
            
                <li><a href="https://paakmau.github.io/tags">tags</a></li>
            
                <li><a href="https://github.com/paakmau" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://paakmau.github.io/202004212139/">快排的多线程优化</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2020-04-21
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/c/">#C++</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/c-stl/">#C++ STL</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/er-fen/">#二分</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/bing-fa/">#并发</a></span>
    

        <div class="post-content">
            <p>讲真我从高中到现在就没有手写过一次快排（是 <code>sort</code> 不够好吗）<br></p>
<span id="continue-reading"></span>
<p>然后最近看书的时候看到划分数据块并行优化的思路，发现快排和堆排都能多线程优化</p>
<p>于是写一个试试</p>
<h2 id="si-lu">思路</h2>
<p>注意到快排在每次迭代后原数组都会被分成没有交集的两块，那么他们就可以并行；堆排也同理</p>
<h2 id="zhu-yi">注意</h2>
<p>有一个问题是不能每次迭代都新开线程（我 CPU 就四个核心线程多也没用）<br>
那就开一个线程池，把迭代后产生的排序任务放到队列里，有一点类似我们递归爆栈时会用到的手写栈</p>
<p>还有一个问题是，在区间长度比较小的时候，由于多线程的调度成本，直接在本线程内递归的性能反而更好</p>
<h2 id="xian-cheng-chi">线程池</h2>
<p>其实比较常见，随便写一个就行</p>
<pre data-lang="cpp" style="background-color:#151515;color:#e8e8d3;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#8fbfdc;">class </span><span style="color:#ffb964;">ThreadPool </span><span>{
</span><span style="color:#8fbfdc;">private</span><span>:
</span><span>    </span><span style="color:#8fbfdc;">typedef</span><span> function&lt;</span><span style="color:#8fbfdc;">void</span><span>()&gt; </span><span style="color:#ffb964;">Task</span><span>;
</span><span>    </span><span style="color:#8fbfdc;">int</span><span> threadCnt;
</span><span>    </span><span style="color:#8fbfdc;">bool</span><span> isRunning;
</span><span>    vector&lt;thread&gt; workers;
</span><span>    queue&lt;Task&gt; tasks;
</span><span>    mutex mtx;
</span><span>    condition_variable cv;
</span><span>    </span><span style="color:#8fbfdc;">void </span><span style="color:#fad07a;">ProcessWorker</span><span>() {
</span><span>        </span><span style="color:#8fbfdc;">while </span><span>(isRunning) {
</span><span>            Task task;
</span><span>            {
</span><span>                unique_lock&lt;mutex&gt; </span><span style="color:#ffb964;">lock</span><span>(mtx);
</span><span>                </span><span style="color:#8fbfdc;">if </span><span>(tasks.</span><span style="color:#ffb964;">empty</span><span>()) cv.</span><span style="color:#ffb964;">wait</span><span>(lock);
</span><span>                </span><span style="color:#8fbfdc;">if </span><span>(!tasks.</span><span style="color:#ffb964;">empty</span><span>()) {
</span><span>                    task = tasks.</span><span style="color:#ffb964;">front</span><span>();
</span><span>                    tasks.</span><span style="color:#ffb964;">pop</span><span>();
</span><span>                }
</span><span>            }
</span><span>            </span><span style="color:#8fbfdc;">if </span><span>(task) </span><span style="color:#ffb964;">task</span><span>();
</span><span>        }
</span><span>    }
</span><span>
</span><span style="color:#8fbfdc;">public</span><span>:
</span><span>    </span><span style="color:#8fbfdc;">explicit </span><span style="color:#fad07a;">ThreadPool</span><span>(</span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">cnt</span><span>) : </span><span style="color:#ffb964;">threadCnt</span><span>(cnt), </span><span style="color:#ffb964;">isRunning</span><span>(</span><span style="color:#cf6a4c;">0</span><span>) {}
</span><span>    </span><span style="color:#fad07a;">~ThreadPool</span><span>() {
</span><span>        </span><span style="color:#8fbfdc;">if </span><span>(isRunning) </span><span style="color:#ffb964;">Stop</span><span>();
</span><span>    }
</span><span>    </span><span style="color:#8fbfdc;">void </span><span style="color:#fad07a;">Start</span><span>() {
</span><span>        isRunning = </span><span style="color:#cf6a4c;">1</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">for </span><span>(</span><span style="color:#8fbfdc;">int</span><span> i = </span><span style="color:#cf6a4c;">0</span><span>; i &lt; threadCnt; i++)
</span><span>            workers.</span><span style="color:#ffb964;">emplace_back</span><span>(</span><span style="color:#ffb964;">thread</span><span>(&amp;ThreadPool::ProcessWorker, </span><span style="color:#ffb964;">this</span><span>));
</span><span>    }
</span><span>    </span><span style="color:#8fbfdc;">void </span><span style="color:#fad07a;">Push</span><span>(</span><span style="color:#8fbfdc;">const</span><span> Task &amp;</span><span style="color:#ffb964;">task</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">if </span><span>(isRunning) {
</span><span>            lock_guard&lt;mutex&gt; </span><span style="color:#ffb964;">lock</span><span>(mtx);
</span><span>            tasks.</span><span style="color:#ffb964;">push</span><span>(task);
</span><span>            cv.</span><span style="color:#ffb964;">notify_one</span><span>();
</span><span>        }
</span><span>    }
</span><span>    </span><span style="color:#8fbfdc;">void </span><span style="color:#fad07a;">Stop</span><span>() {
</span><span>        {
</span><span>            lock_guard&lt;mutex&gt; </span><span style="color:#ffb964;">lock</span><span>(mtx);
</span><span>            isRunning = false;
</span><span>            cv.</span><span style="color:#ffb964;">notify_all</span><span>();
</span><span>        }
</span><span>        </span><span style="color:#8fbfdc;">for </span><span>(</span><span style="color:#8fbfdc;">auto </span><span>&amp;thd : workers) thd.</span><span style="color:#ffb964;">join</span><span>();
</span><span>    }
</span><span>};
</span></code></pre>
<h2 id="he-xin-dai-ma">核心代码</h2>
<p>每一个 <code>SortFunc</code> 对象都是快排中的一次迭代，给他传一个区间就行</p>
<pre data-lang="cpp" style="background-color:#151515;color:#e8e8d3;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">SortFunc </span><span>{
</span><span>    ThreadPool &amp;pool;
</span><span>    vector&lt;</span><span style="color:#8fbfdc;">int</span><span>&gt; &amp;arr;
</span><span>    </span><span style="color:#8fbfdc;">int</span><span> l, r;
</span><span>
</span><span>    </span><span style="color:#fad07a;">SortFunc</span><span>(ThreadPool &amp;</span><span style="color:#ffb964;">pool</span><span>, vector&lt;</span><span style="color:#8fbfdc;">int</span><span>&gt; &amp;</span><span style="color:#ffb964;">arr</span><span>, </span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">l</span><span>, </span><span style="color:#8fbfdc;">int </span><span style="color:#ffb964;">r</span><span>) : </span><span style="color:#ffb964;">pool</span><span>(pool), </span><span style="color:#ffb964;">arr</span><span>(arr), </span><span style="color:#ffb964;">l</span><span>(l), </span><span style="color:#ffb964;">r</span><span>(r) {}
</span><span>    </span><span style="color:#8fbfdc;">void </span><span style="color:#fad07a;">operator()</span><span>() {
</span><span>        </span><span style="color:#8fbfdc;">if </span><span>(l &gt;= r) </span><span style="color:#8fbfdc;">return</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">int</span><span> v = arr[l];
</span><span>        </span><span style="color:#8fbfdc;">int</span><span> ll = l;
</span><span>        </span><span style="color:#8fbfdc;">int</span><span> rr = r;
</span><span>        </span><span style="color:#8fbfdc;">while </span><span>(l &lt; r) {
</span><span>            </span><span style="color:#8fbfdc;">while </span><span>(l &lt;= rr &amp;&amp; arr[l] &lt; v) l++;
</span><span>            </span><span style="color:#8fbfdc;">while </span><span>(r &gt;= ll &amp;&amp; arr[r] &gt; v) r--;
</span><span>            </span><span style="color:#8fbfdc;">if </span><span>(l &lt;= r)
</span><span>                </span><span style="color:#ffb964;">swap</span><span>(arr[l], arr[r]), l++, r--;
</span><span>        }
</span><span>        </span><span style="color:#8fbfdc;">if </span><span>(r - ll + </span><span style="color:#cf6a4c;">1 </span><span>&gt; </span><span style="color:#cf6a4c;">64</span><span>)
</span><span>            pool.</span><span style="color:#ffb964;">Push</span><span>(</span><span style="color:#ffb964;">SortFunc</span><span>(pool, arr, ll, r));
</span><span>        </span><span style="color:#8fbfdc;">else
</span><span>            </span><span style="color:#ffb964;">SortFunc</span><span>(pool, arr, ll, r)();
</span><span>        </span><span style="color:#8fbfdc;">if </span><span>(rr - l + </span><span style="color:#cf6a4c;">1 </span><span>&gt; </span><span style="color:#cf6a4c;">64</span><span>)
</span><span>            pool.</span><span style="color:#ffb964;">Push</span><span>(</span><span style="color:#ffb964;">SortFunc</span><span>(pool, arr, l, rr));
</span><span>        </span><span style="color:#8fbfdc;">else
</span><span>            </span><span style="color:#ffb964;">SortFunc</span><span>(pool, arr, l, rr)();
</span><span>    }
</span><span>};
</span><span>
</span><span style="color:#8fbfdc;">int </span><span style="color:#fad07a;">main</span><span>() {
</span><span>    vector&lt;</span><span style="color:#8fbfdc;">int</span><span>&gt; originArr;
</span><span>    </span><span style="color:#8fbfdc;">for </span><span>(</span><span style="color:#8fbfdc;">int</span><span> i = </span><span style="color:#cf6a4c;">0</span><span>; i &lt; </span><span style="color:#cf6a4c;">1000000</span><span>; i++)
</span><span>        originArr.</span><span style="color:#ffb964;">push_back</span><span>(rand() % </span><span style="color:#cf6a4c;">2000</span><span>);
</span><span>    ThreadPool </span><span style="color:#ffb964;">pool</span><span>(</span><span style="color:#cf6a4c;">4</span><span>);
</span><span>    pool.</span><span style="color:#ffb964;">Start</span><span>();
</span><span>    pool.</span><span style="color:#ffb964;">Push</span><span>(</span><span style="color:#ffb964;">SortFunc</span><span>(pool, originArr, </span><span style="color:#cf6a4c;">0</span><span>, originArr.</span><span style="color:#ffb964;">size</span><span>() - </span><span style="color:#cf6a4c;">1</span><span>));
</span><span>    getchar();
</span><span>    </span><span style="color:#8fbfdc;">return </span><span style="color:#cf6a4c;">0</span><span>;
</span><span>}
</span></code></pre>

        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                    <hr />
                </div>
                <div class="pagination__buttons">
                        <span class="button previous">
                            <a href="https://paakmau.github.io/202004201618/">
                                <span class="button__icon">←</span>&nbsp;
                                <span class="button__text">乒乓缓存与伪共享</span>
                            </a>
                        </span>
                    
                    
                        <span class="button next">
                            <a href="https://paakmau.github.io/202005062356/">
                                <span class="button__text">渲染管线学习</span>&nbsp;
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    </div>
            </div>
        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
