<!DOCTYPE html>
<html lang="en">

<head>
    <title>使用 WSL2 安装 minikube | Celestial</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://paakmau.github.io/style.css">
    <link rel="stylesheet" href="https://paakmau.github.io/color/orange-auto.css">

        <link rel="stylesheet" href="https://paakmau.github.io/color/background_auto.css">
    
    <link rel="stylesheet" href="https://paakmau.github.io/font-hack-subset.css">

    <meta name="description" content="">

    <meta property="og:description" content="">
    <meta property="og:title" content="使用 WSL2 安装 minikube | Celestial">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://paakmau.github.io/202111011219/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="使用 WSL2 安装 minikube | Celestial">
    <meta property="twitter:domain" content="paakmau.github.io">
    <meta property="twitter:url" content="https://paakmau.github.io/202111011219/">

                <link rel="alternate" type="application/rss+xml" title="Celestial RSS Feed" href="https://paakmau.github.io/rss.xml" />
                <link rel="alternate" type="application/atom+xml" title="Celestial Atom Feed" href="https://paakmau.github.io/atom.xml" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral'
        });
    </script>
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://paakmau.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Celestial
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://paakmau.github.io">home</a></li>
            
                <li><a href="https://paakmau.github.io/tags">tags</a></li>
            
                <li><a href="https://github.com/paakmau" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://paakmau.github.io/202111011219/">使用 WSL2 安装 minikube</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2021-11-01
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/k8s/">#k8s</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/minikube/">#minikube</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/podman/">#podman</a></span>
    

        <div class="post-content">
            <p>体验 k8s 比较省事的一个的方法就是直接装 minikube 单机部署。
为了更省事，可以考虑直接在 WSL2 中操作。
<del>省事个锤子，这是折磨。</del>
本文将使用 Podman 作为 minikube 的驱动，而非 Docker。</p>
<span id="continue-reading"></span>
<p>现在安装 WSL2 已经非常方便了，直接在微软商店下载即可。
本文本来使用的是 Debian 11，然后因为踩坑踩到心态炸了最后换成了 Ubuntu 20.04。
另外注意，Ubuntu 不要升级，否则会跟 Debian 11 一样直接爆炸，不要问我为什么会知道。</p>
<h2 id="geng-xin-ruan-jian-bao">更新软件包</h2>
<p>直接更新系统中所有的软件包，这个好习惯可以避免许多陈年老坑。
<del>但是这也会带来更多的新坑。</del></p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> apt update
</span><span style="color:#ffb964;">sudo</span><span> apt upgrade
</span></code></pre>
<h2 id="zhun-bei-gong-zuo">准备工作</h2>
<p>安装一些基础软件包，如果你没有的话。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> apt install curl ca-certificates
</span></code></pre>
<h2 id="an-zhuang-podman">安装 Podman</h2>
<p>Podman 的安装比 Docker 方便很多，如果系统是 Debian 11 或者 Ubuntu 20.10，那么直接一行命令就好了。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> apt install podman
</span></code></pre>
<p>但是如果你的 Ubuntu 版本跟我一样为 20.04，那么就要参考<a href="https://podman.io/getting-started/installation">官方文档</a>添加 Kubic 仓库的软件源。</p>
<h2 id="an-zhuang-minikube">安装 minikube</h2>
<p>也很方便，直接下载二进制可执行文件扔进 <code>/usr/local/bin</code> 里就行了。</p>
<p>如果你可以科学上网，那么直接使用官网提供的这两行命令。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">curl -LO</span><span> https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
</span><span style="color:#ffb964;">sudo</span><span> install minikube-linux-amd64 /usr/local/bin/minikube
</span></code></pre>
<p>或者可以使用阿里云构建的版本。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">curl -Lo</span><span> minikube https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.23.1/minikube-linux-amd64 &amp;&amp; </span><span style="color:#ffb964;">chmod</span><span> +x minikube &amp;&amp; </span><span style="color:#ffb964;">sudo</span><span> mv minikube /usr/local/bin/
</span></code></pre>
<p>至于为什么这两段命令明明可以统一成同一种写法然而并没有，是因为我是直接照搬相应文档中的原文。</p>
<p>然后如果系统是 Debian 11，那就还有一件很重要的事情。
截至发文，官方提供的最新的正式版还有一点问题，参考这个 <a href="https://github.com/kubernetes/minikube/issues/12489">issue</a>。
这个问题在本文发文的五天前才刚刚被解决。
也就是说 <code>v1.23.2</code> 这个版本是不能用的。
<del>于是我直接下载 beta 版结果遇到了其他问题最后我选择放弃并换成了 Ubuntu。</del></p>
<h2 id="chuang-jian-lib-modules-mu-lu">创建 <code>/lib/modules</code> 目录</h2>
<p>WSL2 里的这个目录默认是空的。但是有的发行版（比如 Debian）可能根本没有这个目录，然后就会报一些奇奇怪怪的错误。</p>
<p>如果没有的话那就手动建一个。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> mkdir /lib/modules
</span></code></pre>
<h2 id="xiu-gai-sudoers">修改 sudoers</h2>
<p>有一个莫名其妙的问题是，minikube 本身不需要 sudo 权限，Podman 也可以不需要，但是奇怪的是启动 minikube 的时候会去跑 rootfull 的 Podman。
我看到有人提了这个 <a href="https://github.com/kubernetes/minikube/issues/8719">issue</a>，应该还需要一段时间解决。
官方文档则是建议修改 <code>/etc/sudoers</code> 为 <code>podman</code> 命令配置 sudo 免密。
于是我不想深究这个问题，我决定直接配置所有的命令都 sudo 免密。</p>
<p>于是打开 <code>/etc/sudoers</code>，找到 <code>sudo</code> 的用户组并配置免密。
大致如下：</p>
<pre data-lang="conf" style="background-color:#151515;color:#e8e8d3;" class="language-conf "><code class="language-conf" data-lang="conf"><span style="color:#8fbfdc;">%sudo </span><span>ALL=(ALL:ALL) NOPASSWD: ALL
</span></code></pre>
<h2 id="xiu-gai-podman-pei-zhi">修改 Podman 配置</h2>
<p>目前 minikube 只支持使用 rootfull 的 Podman。
于是我们先直接偷一份 Podman 提供的默认配置文件拷贝到 rootfull 模式的配置目录下。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> cp /usr/share/containers/containers.conf /etc/containers/containers.conf
</span></code></pre>
<p>然后因为 WSL2 的环境比较离谱，它没有 systemd。
所以我们需要修改这个配置文件中的一些内容：</p>
<ul>
<li><code>cgroup_manager</code> 设置为 <code>cgroupfs</code></li>
<li><code>events_logger</code> 设置为 <code>file</code></li>
</ul>
<h2 id="xiu-gai-iptables">修改 iptables</h2>
<p>Debian 10 之后就把 iptables 改为了 nftables。
但是无论是 Docker 还是 Podman 暂时都不支持 nftables。
这个问题在 Ubuntu 上也同样存在。
因此我们先使用旧版的 iptables。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> update-alternatives</span><span style="color:#ffb964;"> --set</span><span> iptables /usr/sbin/iptables-legacy
</span><span style="color:#ffb964;">sudo</span><span> update-alternatives</span><span style="color:#ffb964;"> --set</span><span> ip6tables /usr/sbin/ip6tables-legacy
</span></code></pre>
<h2 id="qi-dong-minikube">启动 minikube</h2>
<p>接下来就很简单了，直接启动 minikube。
很舒服的是 minikube 支持配置镜像。
于是我们直接使用阿里云镜像。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">minikube</span><span> start</span><span style="color:#ffb964;"> --image-mirror-country</span><span> cn</span><span style="color:#ffb964;"> --registry-mirror</span><span>=&lt;aliyun-registry-mirror&gt;
</span></code></pre>
<p>其中的 <code>--registry-mirror</code> 参数你需要指定为你自己的阿里云镜像加速器地址，参考<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">阿里云镜像服务</a>。</p>
<h2 id="shan-ku-pao-lu">删库跑路</h2>
<p>如果你在安装的过程遇到更离谱的问题，或者新版本有所不同，那么你可能很需要知道怎么把这些垃圾全部删除并恢复原状。</p>
<h3 id="xie-zai-minikube">卸载 minikube</h3>
<p>删除所有的容器，以及下载下来的 Docker 镜像。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">minikube</span><span> delete</span><span style="color:#ffb964;"> --all --purge
</span></code></pre>
<p>删除 minikube 的可执行文件。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> rm /usr/local/bin/minikube
</span></code></pre>
<h3 id="xie-zai-podman">卸载 Podman</h3>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">sudo</span><span> apt purge podman
</span></code></pre>

        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                    <hr />
                </div>
                <div class="pagination__buttons">
                        <span class="button previous">
                            <a href="https://paakmau.github.io/202012200030/">
                                <span class="button__icon">←</span>&nbsp;
                                <span class="button__text">C++ Core Guidelines 命名与布局规则</span>
                            </a>
                        </span>
                    
                    
                        <span class="button next">
                            <a href="https://paakmau.github.io/202112312231/">
                                <span class="button__text">RESTful 接口设计经验总结</span>&nbsp;
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    </div>
            </div>
        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
