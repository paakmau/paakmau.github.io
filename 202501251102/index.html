<!DOCTYPE html>
<html lang="en">

<head>
    <title>为 openGauss 配置大页内存 | Celestial</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://paakmau.github.io/style.css">
    <link rel="stylesheet" href="https://paakmau.github.io/color/orange-auto.css">

        <link rel="stylesheet" href="https://paakmau.github.io/color/background_auto.css">
    
    <link rel="stylesheet" href="https://paakmau.github.io/font-hack-subset.css">

    <meta name="description" content="">

    <meta property="og:description" content="">
    <meta property="og:title" content="为 openGauss 配置大页内存 | Celestial">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://paakmau.github.io/202501251102/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="为 openGauss 配置大页内存 | Celestial">
    <meta property="twitter:domain" content="paakmau.github.io">
    <meta property="twitter:url" content="https://paakmau.github.io/202501251102/">

                <link rel="alternate" type="application/rss+xml" title="Celestial RSS Feed" href="https://paakmau.github.io/rss.xml" />
                <link rel="alternate" type="application/atom+xml" title="Celestial Atom Feed" href="https://paakmau.github.io/atom.xml" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral'
        });
    </script>
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://paakmau.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Celestial
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://paakmau.github.io">home</a></li>
            
                <li><a href="https://paakmau.github.io/tags">tags</a></li>
            
                <li><a href="https://github.com/paakmau" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://paakmau.github.io/202501251102/">为 openGauss 配置大页内存</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-01-25
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/opengauss/">#openGauss</a>&nbsp;
                <a class="post-tag" href="https://paakmau.github.io/tags/shu-ju-ku/">#数据库</a></span>
    

        <div class="post-content">
            <p>openGauss 支持使用标准大页来分配共享内存，以提高数据库性能。</p>
<span id="continue-reading"></span>
<ul>
<li>减少页表内存占用</li>
<li>减少页表维护开销</li>
<li>提高快表（TLB）命中率</li>
<li>减少缺页中断次数</li>
</ul>
<h2 id="huan-jing">环境</h2>
<ul>
<li><code>aarch64</code></li>
<li>openEuler 22.03 LTS-SP4</li>
</ul>
<h2 id="cha-xun-da-ye-pei-zhi-yu-zhuang-tai">查询大页配置与状态</h2>
<p>标准大页与普通内存是独立开的，预留的大页会占用内存容量。
比如扩大大页池容量（增加大页预留数量）之后，可通过 <code>free</code> 命令观察到可用内存的减少。</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#888888;"># 查询系统支持的大页大小
</span><span style="color:#ffb964;">ls</span><span> /sys/kernel/mm/hugepages
</span><span>
</span><span style="color:#888888;"># 查询当前大页大小、预留数与分配数
</span><span style="color:#ffb964;">cat</span><span> /proc/meminfo | </span><span style="color:#ffb964;">grep</span><span> Huge
</span><span>
</span><span style="color:#888888;"># 查询内存使用情况
</span><span style="color:#ffb964;">free -h
</span><span>
</span><span style="color:#888888;"># 查询 NUMA 各节点大页预留数与分配数
</span><span style="color:#ffb964;">cat</span><span> /sys/devices/system/node/node*/meminfo | </span><span style="color:#ffb964;">grep</span><span> Huge
</span><span>
</span><span style="color:#888888;"># 查询 NUMA 各节点内存使用情况
</span><span style="color:#ffb964;">numactl -H
</span></code></pre>
<h2 id="pei-zhi-da-ye-chi-rong-liang">配置大页池容量</h2>
<p>大页池与普通内存池的机制类似：</p>
<ul>
<li>大页池最初预留的空闲大页数量与容量相等。</li>
<li>所有的空闲大页用自由表维护</li>
<li>从自由表中取出空闲大页分配给上层应用</li>
<li>上层应用释放大页
<ul>
<li>如果大页总数超过大页池容量，被释放的大页会恢复为普通内存</li>
<li>如果大页总数不超过大页池容量，被释放的大页会被塞回自由表</li>
</ul>
</li>
</ul>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#888888;"># 查询大页池容量
</span><span style="color:#ffb964;">cat</span><span> /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
</span><span>
</span><span style="color:#888888;"># 配置大页池容量
</span><span>echo &lt;huge-page-cnt&gt; &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
</span><span>
</span><span style="color:#888888;"># 查询单个 NUMA 节点大页池容量
</span><span style="color:#ffb964;">cat</span><span> /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
</span><span>
</span><span style="color:#888888;"># 为单个 NUMA 节点配置大页池容量
</span><span>echo &lt;huge-page-cnt&gt; &gt; /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
</span></code></pre>
<h2 id="xiu-gai-da-ye-da-xiao">修改大页大小</h2>
<p>需要修改 GRUB 配置并重启。</p>
<p>修改 <code>/etc/default/grub</code> 文件，找到 <code>GRUB_CMDLINE_LINUX</code>，在里面添加参数以指定大页大小，比如：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">GRUB_CMDLINE_LINUX</span><span>=</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">... default_hugepagesz=2M hugepagesz=2M</span><span style="color:#556633;">&quot;
</span></code></pre>
<p>我们还可以在这里直接指定大页池容量，就不需要每次重启后手动配置了，比如：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">GRUB_CMDLINE_LINUX</span><span>=</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">... default_hugepagesz=2M hugepagesz=2M hugepages=512</span><span style="color:#556633;">&quot;
</span></code></pre>
<p>通过文件 <code>/sys/firmware/efi</code> 确认启动模式：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span>[ </span><span style="color:#ffb964;">-d</span><span> /sys/firmware/efi ] &amp;&amp; echo UEFI || echo BIOS
</span></code></pre>
<p>依据启动模式将 <code>/etc/default/grub</code> 生成到对应的 <code>grub.cfg</code> 中：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#888888;"># BIOS
</span><span style="color:#ffb964;">grub2-mkconfig -o</span><span> /boot/grub2/grub.cfg
</span><span>
</span><span style="color:#888888;"># UEFI
</span><span style="color:#ffb964;">grub2-mkconfig -o</span><span> /boot/efi/EFI/openEuler/grub.cfg
</span></code></pre>
<p>于是直接重启：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">reboot
</span></code></pre>
<p>重启后可以检查一下 GRUB 配置是否生效：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">cat</span><span> /proc/cmdline
</span></code></pre>
<h2 id="yun-xu-yong-hu-zu-fen-pei-da-ye">允许用户组分配大页</h2>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#888888;"># 查询允许分配大页的用户组 ID
</span><span style="color:#ffb964;">sysctl -n</span><span> vm.hugetlb_shm_group
</span><span>
</span><span style="color:#888888;"># 查询用户组 ID
</span><span style="color:#ffb964;">id -g </span><span>&lt;group-name&gt;
</span><span>
</span><span style="color:#888888;"># 配置允许分配大页的用户组 ID
</span><span style="color:#ffb964;">sysctl -w</span><span> vm.hugetlb_shm_group=&lt;group-id&gt;
</span></code></pre>
<h2 id="qi-yong-opengauss-da-ye-gong-neng">启用 openGauss 大页功能</h2>
<p>修改 <code>postgresql.conf</code>：</p>
<pre data-lang="conf" style="background-color:#151515;color:#e8e8d3;" class="language-conf "><code class="language-conf" data-lang="conf"><span style="color:#888888;"># 启用大页
</span><span style="color:#ffb964;">enable_huge_pages </span><span>= on
</span><span>
</span><span style="color:#888888;"># 使用系统默认的大页大小
</span><span style="color:#ffb964;">huge_page_size </span><span>= </span><span style="color:#cf6a4c;">0
</span></code></pre>
<p>或者直接：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">gs_guc</span><span> set</span><span style="color:#ffb964;"> -D </span><span>${</span><span style="color:#ffb964;">PGDATA</span><span>}</span><span style="color:#ffb964;"> -c </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">enable_huge_pages = on</span><span style="color:#556633;">&#39;
</span><span style="color:#ffb964;">gs_guc</span><span> set</span><span style="color:#ffb964;"> -D </span><span>${</span><span style="color:#ffb964;">PGDATA</span><span>}</span><span style="color:#ffb964;"> -c </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">huge_page_size = 0</span><span style="color:#556633;">&#39;
</span></code></pre>
<p>需要重启数据库：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb964;">gs_ctl</span><span> restart
</span></code></pre>
<p>注意，启用大页功能后，<code>gaussdb</code> 启动时会依据 GUC 参数 <code>shared_buffers</code> 指定的容量，尝试通过大页分配共享缓冲区，如果大页池容量不足会导致启动失败。
这时可以估算一下，扩大大页池容量就行。</p>
<h2 id="guan-yu-tou-ming-da-ye">关于透明大页</h2>
<p>参考资料：</p>
<p><a href="https://www.pingcap.com/blog/transparent-huge-pages-why-we-disable-it-for-databases/">https://www.pingcap.com/blog/transparent-huge-pages-why-we-disable-it-for-databases/</a></p>
<p>上文介绍的标准大页需要单独管理，而透明大页可以在上层应用不感知的情况下使用大页分配内存。
在大部分情况下可以实现与标准大页类似的效果，在访问连续内存的场景下减少与页表相关的开销，从而获得更好的性能。
但透明大页需要将普通页合并为大页，会使得系统内核更频繁地触发内存回收与内存压缩，这会增加额外的开销。</p>
<ul>
<li>
<p>内存回收（memory reclaim）</p>
<p>释放掉不必要的内存，涉及 I/O。
典型的场景有：将虚拟内存写回交换分区，随后将其释放；将映射文件的内存写回存储设备（仅脏页），随后释放。</p>
</li>
<li>
<p>内存压缩（memory compaction）</p>
<p>碎片整理，移动被占用的零碎页以获得足够大的连续空闲内存。</p>
</li>
</ul>
<p>而数据库应用访问的内存是比较稀疏的，从大页获得的性能提升较少，于是透明大页带来的开销就变得无法接受了。
开启透明大页导致数据库性能问题时，通常会看到更高的 CPU 占用率。</p>
<p>查询当前透明大页配置：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#888888;"># 控制透明大页是否开启
</span><span style="color:#ffb964;">cat</span><span> /sys/kernel/mm/transparent_hugepage/enabled
</span><span>
</span><span style="color:#888888;"># 该参数用于控制内核是否更积极地执行内存压缩，便于在需要时提供更多的大页
</span><span style="color:#ffb964;">cat</span><span> /sys/kernel/mm/transparent_hugepage/defrag
</span></code></pre>
<p>关闭透明大页相关特性：</p>
<pre data-lang="sh" style="background-color:#151515;color:#e8e8d3;" class="language-sh "><code class="language-sh" data-lang="sh"><span>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</span><span>echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag
</span></code></pre>

        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                    <hr />
                </div>
                <div class="pagination__buttons">
                        <span class="button previous">
                            <a href="https://paakmau.github.io/202501182247/">
                                <span class="button__icon">←</span>&nbsp;
                                <span class="button__text">通过 MySQL Connector&#x2F;J 连接 openGauss</span>
                            </a>
                        </span>
                    
                    
                        <span class="button next">
                            <a href="https://paakmau.github.io/202502062219/">
                                <span class="button__text">为 openGauss 导入 TPC-H 数据集</span>&nbsp;
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    </div>
            </div>
        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
