+++
title = "为 openGauss 配置大页内存"
date = 2025-01-25 11:02:25
slug = "202501251102"

[taxonomies]
tags = ["openGauss", "数据库"]
+++

openGauss 支持使用大页来分配共享内存，以提高数据库性能。

<!-- more -->

## 环境

- `aarch64`
- openEuler 22.03 LTS-SP4

## 查询大页配置与状态

大页与普通内存是独立开的，预留的大页会占用内存容量。
比如扩大大页池容量（增加大页预留数量）之后，可通过 `free` 命令观察到可用内存的减少。

```sh
# 查询系统支持的大页大小
ls /sys/kernel/mm/hugepages

# 查询当前大页大小、预留数与分配数
cat /proc/meminfo | grep Huge

# 查询内存使用情况
free -h

# 查询 NUMA 各节点大页预留数与分配数
cat /sys/devices/system/node/node*/meminfo | grep Huge

# 查询 NUMA 各节点内存使用情况
numactl -H
```

## 配置大页池容量

大页池与普通内存池的机制类似：

- 大页池最初预留的空闲大页数量与容量相等。
- 所有的空闲大页用自由表维护
- 从自由表中取出空闲大页分配给上层应用
- 上层应用释放大页
    - 如果大页总数超过大页池容量，被释放的大页会恢复为普通内存
    - 如果大页总数不超过大页池容量，被释放的大页会被塞回自由表

```sh
# 查询大页池容量
cat /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# 配置大页池容量
echo <huge-page-cnt> > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# 查询单个 NUMA 节点大页池容量
cat /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages

# 为单个 NUMA 节点配置大页池容量
echo <huge-page-cnt> > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
```

## 修改大页大小

需要修改 GRUB 配置并重启。

修改 `/etc/default/grub` 文件，找到 `GRUB_CMDLINE_LINUX`，在里面添加参数以指定大页大小，比如：

```sh
GRUB_CMDLINE_LINUX="... default_hugepagesz=2M hugepagesz=2M"
```

我们还可以在这里直接指定大页池容量，就不需要每次重启后手动配置了，比如：

```sh
GRUB_CMDLINE_LINUX="... default_hugepagesz=2M hugepagesz=2M hugepages=512"
```

通过文件 `/sys/firmware/efi` 确认启动模式：

```sh
[ -d /sys/firmware/efi ] && echo UEFI || echo BIOS
```

依据启动模式将 `/etc/default/grub` 生成到对应的 `grub.cfg` 中：

```sh
# BIOS
grub2-mkconfig -o /boot/grub2/grub.cfg

# UEFI
grub2-mkconfig -o /boot/efi/EFI/openEuler/grub.cfg
```

于是直接重启：

```sh
reboot
```

重启后可以检查一下 GRUB 配置是否生效：

```sh
cat /proc/cmdline
```

## 允许用户组分配大页

```sh
# 查询允许分配大页的用户组 ID
sysctl -n vm.hugetlb_shm_group

# 查询用户组 ID
id -g <group-name>

# 配置允许分配大页的用户组 ID
sysctl -w vm.hugetlb_shm_group=<group-id>
```

## 启用 openGauss 大页功能

修改 `postgresql.conf`：

```conf
# 启用大页
enable_huge_pages = on

# 使用系统默认的大页大小
huge_page_size = 0
```

或者直接：

```sh
gs_guc set -D ${PGDATA} -c 'enable_huge_pages = on'
gs_guc set -D ${PGDATA} -c 'huge_page_size = 0'
```

需要重启数据库：

```sh
gs_ctl restart
```

注意，启用大页功能后，`gaussdb` 启动时会依据 GUC 参数 `shared_buffers` 指定的容量，尝试通过大页分配共享缓冲区，如果大页池容量不足会导致启动失败。
这时可以估算一下，扩大大页池容量就行。
